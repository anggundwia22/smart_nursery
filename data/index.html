<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Nursery System</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=JetBrains+Mono:wght@400;500;600&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:       #080e08;
      --surface:  #0f160f;
      --card:     #141c14;
      --card2:    #182018;
      --border:   #1e2d1e;
      --border2:  #263526;
      --green:    #4ade80;
      --green-dim:#22c55e;
      --amber:    #fbbf24;
      --blue:     #38bdf8;
      --red:      #f87171;
      --text:     #d1fae5;
      --text-dim: #86efac;
      --muted:    #4b7055;
      --mono:     'JetBrains Mono', monospace;
      --sans:     'DM Sans', sans-serif;
      --display:  'Syne', sans-serif;
    }
    :root.light {
      --bg:       #f0faf3;
      --surface:  #e6f4eb;
      --card:     #ffffff;
      --card2:    #f0faf3;
      --border:   #c6e8d0;
      --border2:  #a3d4b4;
      --green:    #16a34a;
      --green-dim:#15803d;
      --amber:    #d97706;
      --blue:     #0284c7;
      --red:      #dc2626;
      --text:     #14532d;
      --text-dim: #166534;
      --muted:    #4b7055;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--sans);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 24px 20px 48px;
      transition: background .3s, color .3s;
      background-image:
        radial-gradient(ellipse 60% 40% at 20% 0%, rgba(34,197,94,0.07) 0%, transparent 60%),
        radial-gradient(ellipse 40% 30% at 80% 100%, rgba(74,222,128,0.05) 0%, transparent 50%);
    }
    :root.light body {
      background-image:
        radial-gradient(ellipse 60% 40% at 20% 0%, rgba(34,197,94,0.1) 0%, transparent 60%),
        radial-gradient(ellipse 40% 30% at 80% 100%, rgba(22,163,74,0.07) 0%, transparent 50%);
    }
    .wrap { max-width: 1280px; margin: 0 auto; }

    /* HEADER */
    .header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:32px; flex-wrap:wrap; }
    .header-left { display:flex; align-items:center; gap:16px; }
    .header-right { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .logo {
      width:48px; height:48px; border-radius:14px; flex-shrink:0;
      background: linear-gradient(135deg,#166534,#4ade80);
      display:flex; align-items:center; justify-content:center; font-size:24px;
      box-shadow: 0 0 20px rgba(74,222,128,0.25);
    }
    .header-title { font-family:var(--display); font-size:1.55rem; font-weight:800; color:var(--green); line-height:1.1; }
    .header-sub { font-size:0.78rem; color:var(--muted); font-family:var(--mono); margin-top:2px; }
    .rtc-box { font-family:var(--mono); font-size:0.88rem; color:var(--text-dim); background:var(--card); border:1px solid var(--border); padding:8px 14px; border-radius:8px; letter-spacing:0.04em; }
    .rtc-box small { display:block; font-size:0.68rem; color:var(--muted); margin-bottom:1px; }
    .conn-badge { display:flex; align-items:center; gap:7px; padding:8px 14px; border-radius:8px; font-size:0.78rem; font-weight:600; font-family:var(--mono); border:1px solid; transition:all .3s; }
    .conn-badge.online  { background:rgba(74,222,128,.1);  border-color:var(--green-dim); color:var(--green); }
    .conn-badge.offline { background:rgba(248,113,113,.1); border-color:var(--red); color:var(--red); }
    .dot { width:8px; height:8px; border-radius:50%; background:currentColor; animation:blink 2s infinite; }
    @keyframes blink { 0%,100%{opacity:1}50%{opacity:.3} }

    /* ANDROID-STYLE TOAST (bottom, non-blocking) */
    .toast-container { position:fixed; bottom:24px; left:50%; transform:translateX(-50%); z-index:9999; padding:0 24px; max-width:calc(100% - 48px); pointer-events:none; }
    .toast { background:#323232; color:rgba(255,255,255,0.92); font-size:14px; padding:12px 20px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,.4); opacity:0; transition:opacity .2s ease; max-width:min(360px, 100%); text-align:center; line-height:1.35; }
    .toast.on { opacity:1; }
    :root.light .toast { background:#424242; color:rgba(255,255,255,0.92); box-shadow:0 4px 12px rgba(0,0,0,.25); }

    /* SECTION LABEL */
    .sec { font-family:var(--mono); font-size:.68rem; font-weight:600; letter-spacing:.15em; text-transform:uppercase; color:var(--muted); margin-bottom:12px; display:flex; align-items:center; gap:10px; }
    .sec::after { content:''; flex:1; height:1px; background:var(--border); }

    /* GRID */
    .g3  { display:grid; grid-template-columns:repeat(3,1fr); gap:14px; margin-bottom:14px; }
    .g5  { display:grid; grid-template-columns:repeat(5,1fr); gap:12px; margin-bottom:14px; }
    .g2  { display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-bottom:14px; }
    .g23 { display:grid; grid-template-columns:2fr 3fr; gap:14px; margin-bottom:14px; }

    /* CARD */
    .card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:18px; position:relative; overflow:hidden; transition:border-color .3s, background .3s; }
    .card:hover { border-color:var(--border2); }
    .card::before { content:''; position:absolute; inset:0; background:linear-gradient(135deg,rgba(74,222,128,.025) 0%,transparent 60%); pointer-events:none; }

    /* THEME TOGGLE */
    .theme-btn { width:38px; height:38px; border-radius:8px; border:1px solid var(--border); background:var(--card); color:var(--text-dim); font-size:1.1rem; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .2s; flex-shrink:0; }
    .theme-btn:hover { border-color:var(--border2); background:var(--card2); }

    /* ENV CARDS */
    .env .clabel { font-family:var(--mono); font-size:.66rem; font-weight:500; letter-spacing:.12em; text-transform:uppercase; color:var(--muted); margin-bottom:6px; display:flex; align-items:center; gap:6px; }
    .env .val  { font-family:var(--mono); font-size:2.8rem; font-weight:600; line-height:1; color:var(--text); margin-bottom:4px; }
    .env .val .u { font-size:.9rem; font-weight:400; color:var(--muted); margin-left:3px; }
    .env .desc { font-size:.75rem; color:var(--muted); font-family:var(--mono); }
    .env.temp   { border-top:2px solid #f97316; }
    .env.humid  { border-top:2px solid var(--blue); }
    .env.lux    { border-top:2px solid var(--amber); }

    /* SOIL CARDS */
    .soil .snum  { font-family:var(--mono); font-size:.62rem; font-weight:600; letter-spacing:.1em; color:var(--muted); margin-bottom:6px; text-transform:uppercase; }
    .soil .sval  { font-family:var(--mono); font-size:1.85rem; font-weight:600; line-height:1; color:var(--text); }
    .soil .sval .u { font-size:.78rem; font-weight:400; color:var(--muted); }
    .soil.soil-avg { grid-column:1 / -1; }
    .soil.soil-avg .snum { font-size:.65rem; letter-spacing:.12em; }
    .soil.soil-avg .sval { font-size:2.25rem; font-weight:700; color:var(--text); }
    .soil.soil-avg .sval .u { font-size:.9rem; }
    .soil .btrack { width:100%; height:4px; background:var(--border); border-radius:3px; margin-top:9px; overflow:hidden; }
    .soil .bfill  { height:100%; border-radius:3px; transition:width .6s ease; background:linear-gradient(90deg,#16a34a,#4ade80); }
    .soil .bfill.dry { background:linear-gradient(90deg,#b45309,#fbbf24); }
    .soil .bfill.wet { background:linear-gradient(90deg,#0369a1,#38bdf8); }
    .soil .slabel { font-size:.62rem; font-family:var(--mono); margin-top:5px; color:var(--muted); text-transform:uppercase; letter-spacing:.08em; }

    /* PUMP CARD ‚Äî unified icon: same shape, state by color/fill/glow */
    .pump-ring { width:78px; height:78px; border-radius:50%; border:3px solid var(--border); display:flex; align-items:center; justify-content:center; margin:0 auto 14px; transition:all .35s ease; cursor:pointer; background:transparent; padding:0; appearance:none; -webkit-appearance:none; }
    .pump-ring:hover { filter:brightness(1.08); }
    .pump-ring:active { transform:scale(0.97); }
    .pump-ring.idle     { border-color:var(--border2); color:var(--muted); }
    .pump-ring.running  { border-color:var(--green); color:var(--green); box-shadow:0 0 0 0 rgba(74,222,128,.35); animation:pulsering 1.8s ease-out infinite; }
    .pump-ring.cooldown { border-color:var(--amber); color:var(--amber); box-shadow:0 0 12px rgba(251,191,36,.2); }
    .pump-ring.error    { border-color:var(--red);   color:var(--red);   box-shadow:0 0 12px rgba(248,113,113,.2); }
    @keyframes pulsering { 0%{box-shadow:0 0 0 0 rgba(74,222,128,.4)} 70%{box-shadow:0 0 0 14px rgba(74,222,128,0)} 100%{box-shadow:0 0 0 0 rgba(74,222,128,0)} }
    .pump-icon { width:32px; height:32px; display:block; transition:fill .35s ease, stroke .35s ease, filter .35s ease; }
    .pump-ring.idle .pump-icon     { fill:none; stroke:currentColor; stroke-width:2.2; stroke-linejoin:round; }
    .pump-ring.running .pump-icon { fill:currentColor; stroke:none; filter:drop-shadow(0 0 6px currentColor); }
    .pump-ring.cooldown .pump-icon { fill:none; stroke:currentColor; stroke-width:2.2; stroke-linejoin:round; }
    .pump-ring.error .pump-icon   { fill:none; stroke:currentColor; stroke-width:2.2; stroke-linejoin:round; }
    .pump-lbl { text-align:center; font-family:var(--mono); font-size:.78rem; font-weight:600; letter-spacing:.12em; text-transform:uppercase; margin-bottom:4px; }
    .pump-lbl.idle     { color:var(--muted); }
    .pump-lbl.running  { color:var(--green); }
    .pump-lbl.cooldown { color:var(--amber); }
    .pump-lbl.error    { color:var(--red); }
    .pump-desc { text-align:center; font-size:.75rem; color:var(--muted); margin-bottom:4px; }
    .pump-source { text-align:center; font-size:.68rem; font-family:var(--mono); color:var(--muted); margin-bottom:14px; min-height:1em; }
    .trow { display:flex; align-items:center; justify-content:space-between; background:var(--card2); border:1px solid var(--border); border-radius:8px; padding:10px 14px; }
    .trow .tl { font-size:.72rem; color:var(--muted); font-family:var(--mono); }
    .trow .tv { font-family:var(--mono); font-weight:600; color:var(--green); font-size:.95rem; }

    /* SCHEDULE CARD */
    .sched-list { display:flex; flex-direction:column; gap:9px; }
    .sched-item { display:flex; align-items:center; justify-content:space-between; background:var(--card2); border:1px solid var(--border); border-radius:8px; padding:11px 15px; }
    .sched-n { font-family:var(--mono); font-size:.64rem; font-weight:600; letter-spacing:.1em; text-transform:uppercase; color:var(--muted); }
    .sched-t { font-family:var(--mono); font-size:1.3rem; font-weight:600; color:var(--text); letter-spacing:.04em; }

    /* DATA */
    .dstats { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:16px; }
    .dstat  { background:var(--card2); border:1px solid var(--border); border-radius:8px; padding:12px; text-align:center; }
    .dstat .dv { font-family:var(--mono); font-size:1.35rem; font-weight:600; color:var(--text); line-height:1; margin-bottom:4px; }
    .dstat .dl { font-size:.65rem; font-family:var(--mono); color:var(--muted); text-transform:uppercase; letter-spacing:.1em; }

    /* CARD HEADER */
    .chard { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .ctitle { font-family:var(--display); font-size:.95rem; font-weight:700; color:var(--text); display:flex; align-items:center; gap:8px; }

    /* BUTTONS */
    .btn { display:inline-flex; align-items:center; gap:7px; padding:10px 17px; border-radius:8px; border:1px solid; font-size:.83rem; font-weight:500; font-family:var(--sans); cursor:pointer; transition:all .2s; }
    .btn:active { transform:scale(.97); }
    .btn-p { background:rgba(74,222,128,.12); border-color:var(--green-dim); color:var(--green); }
    .btn-p:hover { background:rgba(74,222,128,.2); }
    .btn-d { background:rgba(248,113,113,.1); border-color:#ef4444; color:var(--red); }
    .btn-d:hover { background:rgba(248,113,113,.2); }
    .btn-g { background:var(--card2); border-color:var(--border); color:var(--text-dim); }
    .btn-g:hover { border-color:var(--border2); }
    .btn-w { background:rgba(251,191,36,.1); border-color:#d97706; color:var(--amber); }
    .btn-w:hover { background:rgba(251,191,36,.2); }
    .acts { display:flex; gap:10px; flex-wrap:wrap; }

    /* SETTINGS TABS */
    .tabs { display:flex; gap:4px; background:var(--card2); border:1px solid var(--border); border-radius:10px; padding:4px; margin-bottom:20px; }
    .tab  { flex:1; padding:8px 10px; border:none; background:transparent; color:var(--muted); font-size:.75rem; font-weight:500; font-family:var(--mono); border-radius:7px; cursor:pointer; transition:all .2s; letter-spacing:.04em; text-transform:uppercase; }
    .tab.on { background:var(--card); color:var(--green); border:1px solid var(--border); }
    .panel { display:none; }
    .panel.on { display:block; }
    .fgrid { display:grid; grid-template-columns:repeat(auto-fill,minmax(230px,1fr)); gap:14px; }
    .fgrid-jadwal { grid-template-columns:repeat(2,1fr); gap:18px; }
    @media(max-width:520px){ .fgrid-jadwal { grid-template-columns:1fr; } }
    .fg { display:flex; flex-direction:column; gap:6px; }
    .fl { font-family:var(--mono); font-size:.68rem; font-weight:500; letter-spacing:.1em; text-transform:uppercase; color:var(--muted); }
    .fl span { text-transform:none; letter-spacing:0; font-weight:400; }
    .fi { background:var(--card2); border:1px solid var(--border); border-radius:8px; padding:10px 14px; color:var(--text); font-size:.88rem; font-family:var(--mono); transition:border-color .2s; width:100%; }
    .fi:focus { outline:none; border-color:var(--green-dim); box-shadow:0 0 0 3px rgba(74,222,128,.08); }
    .fh { font-size:.7rem; color:var(--muted); }
    .fax { display:flex; gap:10px; margin-top:18px; flex-wrap:wrap; }
    .div { height:1px; background:var(--border); margin:14px 0; }

    /* LOGS */
    .logbox { background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:14px; max-height:360px; overflow-y:auto; font-family:var(--mono); font-size:.76rem; scrollbar-width:thin; scrollbar-color:var(--border) transparent; }
    .logrow { display:flex; gap:12px; align-items:baseline; padding:5px 0; border-bottom:1px solid var(--border); }
    .logrow:last-child { border-bottom:none; }
    .logts  { color:var(--muted); flex-shrink:0; font-size:.7rem; }
    .logmsg { color:var(--text-dim); word-break:break-word; }
    .logempty { text-align:center; padding:24px; color:var(--muted); }

    /* RESPONSIVE */
    @media(max-width:1024px){ .g23{grid-template-columns:1fr 1fr;} }
    @media(max-width:800px) { .g3{grid-template-columns:1fr 1fr;} .g5{grid-template-columns:repeat(2,1fr);} .g2,.g23{grid-template-columns:1fr;} }
    @media(max-width:520px) { .g3{grid-template-columns:1fr;} .header{flex-direction:column;align-items:flex-start;} .env .val{font-size:2.4rem;} }
  </style>
</head>
<body>
<div class="wrap">

  <!-- HEADER -->
  <header class="header">
    <div class="header-left">
      <div class="logo">üåø</div>
      <div>
        <div class="header-title">Smart Nursery</div>
        <div class="header-sub">Monitoring &amp; Irrigation Control ‚Äî ESP32</div>
      </div>
    </div>
    <div class="header-right">
      <div class="rtc-box">
        <small>RTC</small>
        <span id="rtcTime">--/--/---- --:--:--</span>
      </div>
      <button class="theme-btn" id="themeBtn" onclick="toggleTheme()" title="Toggle light/dark mode">üåô</button>
      <div class="conn-badge online" id="connBadge">
        <div class="dot"></div>
        <span id="connTxt">Online</span>
      </div>
    </div>
  </header>

  <!-- ANDROID-STYLE TOAST (bottom overlay) -->
  <div class="toast-container">
    <div class="toast" id="toast" aria-live="polite"></div>
  </div>

  <!-- ENVIRONMENT -->
  <div class="sec">Environment</div>
  <div class="g3">
    <div class="card env temp">
      <div class="clabel">üå°Ô∏è Suhu</div>
      <div class="val"><span id="temperature">--</span><span class="u">¬∞C</span></div>
      <div class="desc" id="tempDesc">‚Äì</div>
    </div>
    <div class="card env humid">
      <div class="clabel">üíß Kelembaban Udara</div>
      <div class="val"><span id="humidity">--</span><span class="u">%</span></div>
      <div class="desc" id="humidDesc">‚Äì</div>
    </div>
    <div class="card env lux">
      <div class="clabel">‚òÄÔ∏è Intensitas Cahaya</div>
      <div class="val"><span id="lux">--</span><span class="u">lx</span></div>
      <div class="desc" id="luxDesc">‚Äì</div>
    </div>
  </div>

  <!-- SOIL MOISTURE (average + 10 sensors) -->
  <div class="sec">Kelembaban Tanah</div>
  <div class="g5">
    <div class="card soil soil-avg">
      <div class="snum">Rata-Rata Kelembaban Tanah</div>
      <div class="sval"><span id="soilAvgVal">--</span><span class="u" id="soilAvgUnit">%</span></div>
      <div class="btrack"><div class="bfill" id="soilAvgBar" style="width:0%"></div></div>
      <div class="slabel" id="soilAvgLabel">‚Äì</div>
    </div>
    <div class="card soil"><div class="snum">Sensor 01</div><div class="sval"><span id="sm1">--</span><span class="u">%</span></div><div class="btrack"><div class="bfill" id="bar1" style="width:0%"></div></div><div class="slabel" id="sl1">‚Äì</div></div>
    <div class="card soil"><div class="snum">Sensor 02</div><div class="sval"><span id="sm2">--</span><span class="u">%</span></div><div class="btrack"><div class="bfill" id="bar2" style="width:0%"></div></div><div class="slabel" id="sl2">‚Äì</div></div>
    <div class="card soil"><div class="snum">Sensor 03</div><div class="sval"><span id="sm3">--</span><span class="u">%</span></div><div class="btrack"><div class="bfill" id="bar3" style="width:0%"></div></div><div class="slabel" id="sl3">‚Äì</div></div>
    <div class="card soil"><div class="snum">Sensor 04</div><div class="sval"><span id="sm4">--</span><span class="u">%</span></div><div class="btrack"><div class="bfill" id="bar4" style="width:0%"></div></div><div class="slabel" id="sl4">‚Äì</div></div>
    <div class="card soil"><div class="snum">Sensor 05</div><div class="sval"><span id="sm5">--</span><span class="u">%</span></div><div class="btrack"><div class="bfill" id="bar5" style="width:0%"></div></div><div class="slabel" id="sl5">‚Äì</div></div>
    <div class="card soil"><div class="snum">Sensor 06</div><div class="sval"><span id="sm6">--</span><span class="u">%</span></div><div class="btrack"><div class="bfill" id="bar6" style="width:0%"></div></div><div class="slabel" id="sl6">‚Äì</div></div>
    <div class="card soil"><div class="snum">Sensor 07</div><div class="sval"><span id="sm7">--</span><span class="u">%</span></div><div class="btrack"><div class="bfill" id="bar7" style="width:0%"></div></div><div class="slabel" id="sl7">‚Äì</div></div>
    <div class="card soil"><div class="snum">Sensor 08</div><div class="sval"><span id="sm8">--</span><span class="u">%</span></div><div class="btrack"><div class="bfill" id="bar8" style="width:0%"></div></div><div class="slabel" id="sl8">‚Äì</div></div>
    <div class="card soil"><div class="snum">Sensor 09</div><div class="sval"><span id="sm9">--</span><span class="u">%</span></div><div class="btrack"><div class="bfill" id="bar9" style="width:0%"></div></div><div class="slabel" id="sl9">‚Äì</div></div>
    <div class="card soil"><div class="snum">Sensor 10</div><div class="sval"><span id="sm10">--</span><span class="u">%</span></div><div class="btrack"><div class="bfill" id="bar10" style="width:0%"></div></div><div class="slabel" id="sl10">‚Äì</div></div>
  </div>

  <!-- PUMP + SCHEDULE -->
  <div class="sec">Pompa &amp; Jadwal</div>
  <div class="g23">

    <div class="card">
      <div class="chard">
        <div class="ctitle">‚öôÔ∏è Status Pompa</div>
      </div>
      <button type="button" class="pump-ring idle" id="pumpRing" onclick="togglePump()" title="Klik untuk menyalakan pompa" aria-label="Pompa ON/OFF">
        <svg class="pump-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M8 5v14l11-7L8 5z" stroke-linejoin="round"/>
        </svg>
      </button>
      <div class="pump-lbl idle" id="pumpLbl">IDLE</div>
      <div class="pump-desc" id="pumpDesc">Sistem standby</div>
      <div class="pump-source" id="pumpControlSource"></div>
      <div class="trow">
        <span class="tl">THRESHOLD</span>
        <span class="tv"><span id="thresholdVal">--</span>%</span>
      </div>
    </div>

    <div class="card">
      <div class="chard">
        <div class="ctitle">üïê Jadwal Penyiraman</div>
      </div>
      <div class="sched-list">
        <div class="sched-item">
          <div><div class="sched-n">Jadwal 1</div><div class="sched-t" id="sched1">--:--</div></div>
        </div>
        <div class="sched-item">
          <div><div class="sched-n">Jadwal 2</div><div class="sched-t" id="sched2">--:--</div></div>
        </div>
      </div>
      <div class="div"></div>
      <p style="font-size:.75rem;color:var(--muted);font-family:var(--mono);">Pompa aktif otomatis sesuai jadwal jika kelembaban &lt; threshold</p>
    </div>

  </div>

  <!-- DATA MANAGEMENT -->
  <div class="sec">Data Log</div>
  <div class="card" style="margin-bottom:14px">
    <div class="chard">
      <div class="ctitle">üìä Manajemen Data CSV</div>
    </div>
    <div class="dstats">
      <div class="dstat"><div class="dv" id="dataRecords">--</div><div class="dl">Records</div></div>
      <div class="dstat"><div class="dv" id="dataSize">--</div><div class="dl">File Size</div></div>
      <div class="dstat"><div class="dv" id="nextLog">--</div><div class="dl">Next Log</div></div>
    </div>
    <div class="acts">
      <button class="btn btn-p" onclick="downloadData()">üì• Download CSV</button>
      <button class="btn btn-d" onclick="deleteData()">üóë Hapus Semua Data</button>
    </div>
  </div>

  <!-- RTC SET DATETIME -->
  <div class="sec">Waktu Sistem</div>
  <div class="card" style="margin-bottom:14px">
    <div class="chard">
      <div class="ctitle">üï∞Ô∏è Update Tanggal &amp; Waktu RTC</div>
    </div>
    <div class="fgrid">
      <div class="fg">
        <div class="fl">Tanggal</div>
        <input type="date" id="rtcDate" class="fi">
        <div class="fh">Tanggal yang akan diset ke RTC</div>
      </div>
      <div class="fg">
        <div class="fl">Waktu</div>
        <input type="time" id="rtcTimeInput" class="fi" step="1">
        <div class="fh">Jam:menit:detik yang akan diset ke RTC</div>
      </div>
      <div class="fg" style="justify-content:flex-end">
        <button class="btn btn-g" onclick="fillNow()" style="margin-bottom:8px">‚ü≥ Pakai Waktu Sekarang</button>
        <button class="btn btn-p" onclick="setDateTime()">üíæ Update RTC</button>
      </div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div class="sec">Pengaturan</div>
  <div class="card" style="margin-bottom:14px">
    <div class="tabs">
      <button class="tab on" onclick="swTab('jadwal',this)">Jadwal</button>
      <button class="tab"    onclick="swTab('pompa',this)">Sensor &amp; Pompa</button>
      <button class="tab"    onclick="swTab('kalib',this)">Kalibrasi</button>
    </div>

    <!-- Tab: Jadwal (HH:MM only) -->
    <div class="panel on" id="panel-jadwal">
      <div class="fgrid fgrid-jadwal">
        <div class="fg">
          <div class="fl">Jadwal 1 <span>(HH:MM)</span></div>
          <input type="time" id="irrigationTime1" class="fi" value="07:00" step="60" min="00:00" max="23:59">
          <div class="fh">Waktu penyiraman pertama setiap hari</div>
        </div>
        <div class="fg">
          <div class="fl">Jadwal 2 <span>(HH:MM)</span></div>
          <input type="time" id="irrigationTime2" class="fi" value="16:00" step="60" min="00:00" max="23:59">
          <div class="fh">Waktu penyiraman kedua setiap hari</div>
        </div>
      </div>
      <div class="fax">
        <button class="btn btn-p" onclick="saveSettings()">üíæ Simpan Jadwal</button>
      </div>
    </div>

    <!-- Tab: Sensor & Pompa -->
    <div class="panel" id="panel-pompa">
      <div class="fgrid">
        <div class="fg">
          <div class="fl">Threshold Kelembaban <span>(%)</span></div>
          <input type="number" id="threshold" class="fi" min="0" max="100" value="60">
          <div class="fh">Pompa aktif jika kelembaban &lt; nilai ini</div>
        </div>
        <div class="fg">
          <div class="fl">Durasi Pompa <span>(detik)</span></div>
          <input type="number" id="pumpDuration" class="fi" min="1" max="600" value="60">
          <div class="fh">Lama pompa menyala setiap siklus</div>
        </div>
        <div class="fg">
          <div class="fl">Interval Pengukuran <span>(detik)</span></div>
          <input type="number" id="measurementInterval" class="fi" min="2" max="3600" value="1800">
          <div class="fh">Seberapa sering sensor membaca data</div>
        </div>
        <div class="fg">
          <div class="fl">Interval Log Data <span>(detik)</span></div>
          <input type="number" id="dataLogInterval" class="fi" min="60" max="3600" value="1800">
          <div class="fh">Interval simpan ke CSV (60‚Äì3600 dtk)</div>
        </div>
      </div>
      <div class="fax">
        <button class="btn btn-p" onclick="saveSettings()">üíæ Simpan Pengaturan</button>
      </div>
    </div>

    <!-- Tab: Kalibrasi -->
    <div class="panel" id="panel-kalib">
      <div class="fgrid">
        <div class="fg">
          <div class="fl">ADC Kering <span>(dry)</span></div>
          <input type="number" id="dry" class="fi" value="2662">
          <div class="fh">Nilai ADC sensor di udara (kering) ‚Äî default 2662</div>
        </div>
        <div class="fg">
          <div class="fl">ADC Basah <span>(wet)</span></div>
          <input type="number" id="wet" class="fi" value="1269">
          <div class="fh">Nilai ADC sensor di air (basah) ‚Äî default 1269</div>
        </div>
      </div>
      <p style="font-size:.73rem;color:var(--muted);font-family:var(--mono);margin-top:14px;">
        Rumus: <code style="color:var(--text-dim)">pct = map(constrain(raw, wet, dry), wet, dry, 0, 100)</code>
      </p>
      <div class="fax">
        <button class="btn btn-p" onclick="saveSettings()">üíæ Simpan Kalibrasi</button>
      </div>
    </div>

    <div class="div"></div>
    <button class="btn btn-w" onclick="restartSystem()">üîÑ Restart Sistem</button>
  </div>

  <!-- LOGS -->
  <div class="sec">Log Aktivitas</div>
  <div class="card">
    <div class="chard">
      <div class="ctitle">üìã Serial Log</div>
      <button class="btn btn-g" onclick="fetchLogs()" style="padding:6px 12px;font-size:.75rem;">‚Üª Refresh</button>
    </div>
    <div class="logbox" id="logbox">
      <div class="logempty">Memuat log‚Ä¶</div>
    </div>
  </div>

</div><!-- /wrap -->

<script>
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // THEME
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function toggleTheme() {
    const isLight = document.documentElement.classList.toggle('light');
    document.getElementById('themeBtn').textContent = isLight ? 'üåô' : '‚òÄÔ∏è';
    localStorage.setItem('nursery-theme', isLight ? 'light' : 'dark');
  }

  // Apply saved theme immediately
  (function() {
    const saved = localStorage.getItem('nursery-theme');
    if (saved === 'light') {
      document.documentElement.classList.add('light');
      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('themeBtn').textContent = '‚òÄÔ∏è';
      });
    }
  })();

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // STATE
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let threshold = 60;
  let rtcMs = null, rtcFetchedAt = null;

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // HELPERS
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const pad = n => String(n).padStart(2,'0');

  const TOAST_DURATION_MS = 2500;
  const TOAST_FADEOUT_MS = 200;
  const toastQueue = [];
  let toastShowing = false;
  let toastTimeout = null;

  function showAlert(msg, type) {
    toastQueue.push({ msg: String(msg), type: type || 'success' });
    processToastQueue();
  }

  function processToastQueue() {
    if (toastShowing || toastQueue.length === 0) return;
    toastShowing = true;
    const { msg } = toastQueue.shift();
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.add('on');
    clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => {
      el.classList.remove('on');
      setTimeout(() => {
        toastShowing = false;
        processToastQueue();
      }, TOAST_FADEOUT_MS);
    }, TOAST_DURATION_MS);
  }

  function swTab(name, btn) {
    document.querySelectorAll('.tab').forEach(b => b.classList.remove('on'));
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('on'));
    btn.classList.add('on');
    document.getElementById('panel-' + name).classList.add('on');
  }

  function escHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function millisToHMS(ms) {
    const s = Math.floor(ms / 1000);
    return pad(Math.floor(s/3600)) + ':' + pad(Math.floor((s%3600)/60)) + ':' + pad(s%60);
  }

  function soilClass(v) { return v < 30 ? 'dry' : v > 70 ? 'wet' : ''; }
  function soilText(v)  { return v < 30 ? 'Kering' : v < 60 ? 'Normal' : v < 80 ? 'Lembap' : 'Sangat Basah'; }

  function updateSoil(i, val) {
    if (val === undefined || val === null) return;
    document.getElementById('sm'  + i).textContent  = val;
    const bar = document.getElementById('bar' + i);
    bar.style.width = Math.min(100, Math.max(0, val)) + '%';
    bar.className   = 'bfill ' + soilClass(val);
    document.getElementById('sl'  + i).textContent  = soilText(val);
    // amber border when dry
    bar.closest('.card').style.borderColor = val < threshold ? 'rgba(251,191,36,0.4)' : '';
  }

  function updateSoilAverage(d) {
    const vals = [];
    for (let i = 1; i <= 10; i++) {
      const v = d['soilMoisture' + i];
      if (v !== undefined && v !== null && !isNaN(Number(v))) vals.push(Number(v));
    }
    const avgValEl = document.getElementById('soilAvgVal');
    const avgUnitEl = document.getElementById('soilAvgUnit');
    const avgBar = document.getElementById('soilAvgBar');
    const avgLabel = document.getElementById('soilAvgLabel');
    if (vals.length === 0) {
      avgValEl.textContent = 'Data tidak tersedia.';
      avgUnitEl.style.display = 'none';
      avgBar.style.width = '0%';
      avgBar.className = 'bfill';
      avgLabel.textContent = '';
    } else {
      const avg = vals.reduce((a, b) => a + b, 0) / vals.length;
      const rounded = Math.round(avg);
      avgValEl.textContent = rounded;
      avgUnitEl.style.display = '';
      avgBar.style.width = Math.min(100, Math.max(0, avg)) + '%';
      avgBar.className = 'bfill ' + soilClass(avg);
      avgLabel.textContent = soilText(avg);
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // RTC CLOCK (local increment)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function syncRTC() {
    try {
      const r = await fetch('/datetime');
      const d = await r.json();
      rtcMs = new Date(d.date + 'T' + d.time).getTime();
      rtcFetchedAt = Date.now();
    } catch(e) {}
  }

  setInterval(() => {
    if (rtcMs === null) return;
    const now = new Date(rtcMs + (Date.now() - rtcFetchedAt));
    document.getElementById('rtcTime').textContent =
      now.getFullYear() + '/' + pad(now.getMonth()+1) + '/' + pad(now.getDate()) +
      '  ' + pad(now.getHours()) + ':' + pad(now.getMinutes()) + ':' + pad(now.getSeconds());
  }, 1000);

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Pump ON/OFF (POST /pump)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function togglePump() {
    const ringState = document.getElementById('pumpRing').getAttribute('data-pump-state');
    const turnOn = (ringState !== '1');
    const state = turnOn ? 'on' : 'off';
    try {
      const r = await fetch('/pump', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'state=' + state,
      });
      const d = await r.json().catch(() => ({}));
      if (r.ok && (d.status === 'success' || d.status === undefined)) {
        showAlert(turnOn ? 'Pompa berhasil dinyalakan.' : 'Pompa berhasil dimatikan.', 'success');
        setTimeout(fetchStatus, 400);
      } else {
        showAlert('Gagal mengontrol pompa. Periksa koneksi atau status sistem.', 'error');
      }
    } catch(e) {
      showAlert('Terjadi kesalahan: ' + e.message, 'error');
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // /status
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function fetchStatus() {
    try {
      const d = await fetch('/status').then(r => r.json());

      // Temperature
      const t = parseFloat(d.temperature);
      document.getElementById('temperature').textContent = isNaN(t) ? '--' : t.toFixed(1);
      document.getElementById('tempDesc').textContent =
        isNaN(t) ? '‚Äì' : t<18?'Dingin':t<28?'Normal':t<35?'Hangat':'Panas';

      // Humidity
      const h = parseFloat(d.humidity);
      document.getElementById('humidity').textContent = isNaN(h) ? '--' : h.toFixed(1);
      document.getElementById('humidDesc').textContent =
        isNaN(h) ? '‚Äì' : h<30?'Kering':h<60?'Normal':h<80?'Lembap':'Sangat Lembap';

      // Lux ‚Äî not in /status yet; shows '--' until handleStatus() is updated
      document.getElementById('lux').textContent = d.lux !== undefined ? Math.round(d.lux) : '--';

      // Threshold
      threshold = d.threshold ?? threshold;
      document.getElementById('thresholdVal').textContent = d.threshold ?? '--';

      // Soil 1‚Äì10 and average
      for (let i = 1; i <= 10; i++) updateSoil(i, d['soilMoisture' + i]);
      updateSoilAverage(d);

      // Pump ‚Äî play (‚ñ∂) when off, pause (‚è∏) when running; ring is a button
      const pumpMap = {
        0: { cls:'idle',     em:'‚ñ∂', lbl:'IDLE',     dsc:'Sistem standby'           },
        1: { cls:'running',  em:'‚è∏', lbl:'RUNNING',  dsc:'Sedang menyiram...'       },
        2: { cls:'cooldown', em:'‚ñ∂', lbl:'COOLDOWN', dsc:'Menunggu sebelum kembali'  },
        3: { cls:'error',    em:'‚ñ∂', lbl:'ERROR',    dsc:'Cek pompa &amp; relay'    },
      };
      const ps = pumpMap[d.pumpState] ?? pumpMap[0];
      const ringEl = document.getElementById('pumpRing');
      ringEl.className = 'pump-ring ' + ps.cls;
      ringEl.setAttribute('data-pump-state', String(d.pumpState ?? 0));
      ringEl.title = (d.pumpState === 1) ? 'Klik untuk mematikan pompa' : 'Klik untuk menyalakan pompa';
      ringEl.setAttribute('aria-label', (d.pumpState === 1) ? 'Pompa OFF' : 'Pompa ON');
      document.getElementById('pumpLbl').className   = 'pump-lbl '   + ps.cls;
      document.getElementById('pumpLbl').textContent = ps.lbl;
      document.getElementById('pumpDesc').innerHTML  = ps.dsc;

      const controlSourceTxt = { 0: '', 1: 'Kontrol: Manual', 2: 'Kontrol: Kelembaban tanah', 3: 'Kontrol: Jadwal' };
      document.getElementById('pumpControlSource').textContent = controlSourceTxt[d.controlSource] ?? '';

      // Schedule display
      if (d.irrigationHour1 !== undefined)
        document.getElementById('sched1').textContent = pad(d.irrigationHour1)+':'+pad(d.irrigationMinute1);
      if (d.irrigationHour2 !== undefined)
        document.getElementById('sched2').textContent = pad(d.irrigationHour2)+':'+pad(d.irrigationMinute2);

      // Connection
      const cb = document.getElementById('connBadge');
      cb.className = 'conn-badge online';
      document.getElementById('connTxt').textContent = 'Online';

    } catch(e) {
      const cb = document.getElementById('connBadge');
      cb.className = 'conn-badge offline';
      document.getElementById('connTxt').textContent = 'Offline';
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // /config
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function fetchConfig() {
    try {
      const d = await fetch('/config').then(r => r.json());

      document.getElementById('threshold').value          = d.threshold          ?? 60;
      document.getElementById('pumpDuration').value       = (d.pumpDuration      ?? 60000) / 1000;
      document.getElementById('measurementInterval').value = (d.measurementInterval ?? 3600000) / 1000;
      document.getElementById('dataLogInterval').value    = (d.dataLogInterval   ?? 3600000) / 1000;
      document.getElementById('dry').value                = d.dry ?? 2662;
      document.getElementById('wet').value                = d.wet ?? 1269;

      document.getElementById('irrigationTime1').value = pad(d.irrigationHour1??7)+':'+pad(d.irrigationMinute1??0);
      document.getElementById('irrigationTime2').value = pad(d.irrigationHour2??16)+':'+pad(d.irrigationMinute2??0);

    } catch(e) { console.error('fetchConfig:', e); }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // SET RTC DATETIME
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function fillNow() {
    const now = new Date();
    document.getElementById('rtcDate').value =
      now.getFullYear() + '-' + pad(now.getMonth()+1) + '-' + pad(now.getDate());
    document.getElementById('rtcTimeInput').value =
      pad(now.getHours()) + ':' + pad(now.getMinutes()) + ':' + pad(now.getSeconds());
  }

  async function setDateTime() {
    const dateVal = document.getElementById('rtcDate').value;
    const timeVal = document.getElementById('rtcTimeInput').value;

    if (!dateVal || !timeVal) {
      showAlert('Mohon isi tanggal dan waktu terlebih dahulu.', 'error');
      return;
    }

    const [year, month, day] = dateVal.split('-').map(Number);
    const timeParts = timeVal.split(':').map(Number);
    const hour = timeParts[0], minute = timeParts[1], second = timeParts[2] || 0;

    const params = new URLSearchParams({ year, month, day, hour, minute, second });

    try {
      const r = await fetch('/datetime', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params,
      });
      const d = await r.json();
      if (r.ok && d.status === 'success') {
        showAlert('Waktu sistem (RTC) berhasil diperbarui.', 'success');
        // Re-sync our local RTC mirror
        rtcMs = new Date(dateVal + 'T' + timeVal).getTime();
        rtcFetchedAt = Date.now();
      } else {
        showAlert('Gagal memperbarui RTC. ' + (d.error || d.message || ''), 'error');
      }
    } catch(e) { showAlert('Terjadi kesalahan: ' + e.message, 'error'); }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function saveSettings() {
    const t1 = (document.getElementById('irrigationTime1').value||'07:00').split(':');
    const t2 = (document.getElementById('irrigationTime2').value||'16:00').split(':');
    const hour1 = Math.min(23, Math.max(0, parseInt(t1[0], 10) || 0));
    const min1  = Math.min(59, Math.max(0, parseInt(t1[1], 10) || 0));
    const hour2 = Math.min(23, Math.max(0, parseInt(t2[0], 10) || 0));
    const min2  = Math.min(59, Math.max(0, parseInt(t2[1], 10) || 0));

    // Schedule is HH:MM only; send 0 for seconds (minute precision / truncate)
    const params = new URLSearchParams({
      threshold:           document.getElementById('threshold').value,
      pumpDuration:        parseInt(document.getElementById('pumpDuration').value) * 1000,
      measurementInterval: document.getElementById('measurementInterval').value,
      dataLogInterval:     document.getElementById('dataLogInterval').value,
      dry:                 document.getElementById('dry').value,
      wet:                 document.getElementById('wet').value,
      irrigationHour1:     hour1,
      irrigationMinute1:   min1,
      irrigationSecond1:   '0',
      irrigationHour2:     hour2,
      irrigationMinute2:   min2,
      irrigationSecond2:   '0',
    });

    try {
      const r = await fetch('/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params,
      });
      if (r.ok) {
        showAlert('Pengaturan berhasil diperbarui.', 'success');
        setTimeout(() => { fetchStatus(); fetchConfig(); }, 800);
      } else {
        showAlert('Gagal menyimpan pengaturan.', 'error');
      }
    } catch(e) { showAlert('Terjadi kesalahan: ' + e.message, 'error'); }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // /data/*
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function fetchDataInfo() {
    try {
      const d = await fetch('/data/info').then(r => r.json());
      document.getElementById('dataRecords').textContent = d.records ?? 0;
      document.getElementById('dataSize').textContent = d.size ? (d.size/1024).toFixed(1)+' KB' : '0 KB';
      if (d.nextLogSeconds !== undefined) {
        const m = Math.floor(d.nextLogSeconds/60);
        const s = d.nextLogSeconds % 60;
        document.getElementById('nextLog').textContent = m+'m '+pad(s)+'s';
      } else {
        document.getElementById('nextLog').textContent = '--';
      }
    } catch(e) {}
  }

  async function downloadData() {
    try {
      const r = await fetch('/data/download');
      if (!r.ok) { showAlert('Tidak ada data tersedia.', 'error'); return; }
      const blob = await r.blob();
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), { href: url, download: 'sensor_data.csv' });
      document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
      showAlert('Data berhasil diunduh.', 'success');
    } catch(e) { showAlert('Terjadi kesalahan: ' + e.message, 'error'); }
  }

  async function deleteData() {
    if (!confirm('Hapus SEMUA data log?\n\nTindakan ini tidak dapat dibatalkan.')) return;
    try {
      const d = await fetch('/data/delete', { method:'POST' }).then(r => r.json());
      if (d.status === 'success') {
        showAlert('Semua data berhasil dihapus.', 'success');
        setTimeout(fetchDataInfo, 800);
      } else {
        showAlert('Gagal menghapus data.', 'error');
      }
    } catch(e) { showAlert('Terjadi kesalahan: ' + e.message, 'error'); }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // /restart
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function restartSystem() {
    if (!confirm('Restart sistem sekarang?')) return;
    try {
      await fetch('/restart', { method:'POST' });
    } catch(e) { /* ESP closes conn on restart */ }
    showAlert('Sistem sedang merestart. Halaman akan dimuat ulang dalam beberapa detik.', 'success');
    setTimeout(() => location.reload(), 8000);
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // /logs
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function fetchLogs() {
    try {
      const d = await fetch('/logs').then(r => r.json());
      const box = document.getElementById('logbox');
      if (!d.logs || !d.logs.length) {
        box.innerHTML = '<div class="logempty">Tidak ada log tersedia</div>';
        return;
      }

      // The most recent log entry timestamp ‚âà ESP32 millis "now".
      // We know RTC "now" locally, so we can convert every millis
      // to a real wall-clock time:
      //   realTime(entry) = rtcNow - (latestMillis - entry.millis)
      const rtcNow = (rtcMs !== null)
        ? rtcMs + (Date.now() - rtcFetchedAt)
        : null;
      const latestMillis = Math.max(...d.logs.map(l => l.timestamp));

      function logTime(ms) {
        if (rtcNow === null) return millisToHMS(ms); // fallback to uptime
        const entryRtc = new Date(rtcNow - (latestMillis - ms));
        return pad(entryRtc.getHours()) + ':' +
               pad(entryRtc.getMinutes()) + ':' +
               pad(entryRtc.getSeconds());
      }

      box.innerHTML = d.logs.map(l =>
        `<div class="logrow"><span class="logts">${logTime(l.timestamp)}</span><span class="logmsg">${escHtml(l.message)}</span></div>`
      ).join('');
      box.scrollTop = box.scrollHeight;    } catch(e) {
      document.getElementById('logbox').innerHTML = '<div class="logempty">Gagal memuat log</div>';
    }
  }

  async function refreshAll() {
    await Promise.all([fetchStatus(), fetchLogs(), fetchDataInfo()]);
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // INIT
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  window.onload = async function() {
    await syncRTC();
    fillNow();
    await Promise.all([fetchStatus(), fetchConfig(), fetchLogs(), fetchDataInfo()]);

    setInterval(refreshAll, 5000);
    setInterval(syncRTC, 60000);
  };
</script>
</body>
</html>